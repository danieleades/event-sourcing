# Stores & Codecs

The crate separates storage concerns into three traits: `EventStore` for event persistence, `SnapshotStore` for aggregate snapshots, and `Codec` for serialization.

## The `EventStore` Trait

```rust,ignore
{{#include ../../../sourcery-core/src/store.rs:event_store_trait}}
```

## Built-in: `inmemory::Store`

For testing and prototyping:

```rust,ignore
use sourcery::store::{inmemory, JsonCodec};

// With unit metadata
let store: inmemory::Store<String, JsonCodec, ()> = inmemory::Store::new(JsonCodec);

// With custom metadata
let store: inmemory::Store<String, JsonCodec, MyMetadata> = inmemory::Store::new(JsonCodec);
```

Features:
- Uses `u64` positions (global sequence number)
- Events stored in memory (lost on drop)
- Deduplicates overlapping filters when loading

## Transactions

Events are appended within a transaction for atomicity:

```rust,ignore
use sourcery::concurrency::Unchecked;

let mut tx = store.begin::<Unchecked>("account", "ACC-001".to_string(), None);
tx.append(event1, metadata.clone())?;
tx.append(event2, metadata.clone())?;
tx.commit().await?; // Events visible only after commit
```

If the transaction is dropped without committing, no events are persisted.

## Event Filters

Control which events to load:

```rust,ignore
// All events of a specific kind (across all aggregates)
EventFilter::for_event("account.deposited")

// All events for a specific aggregate instance
EventFilter::for_aggregate("account.deposited", "account", "ACC-001")

// Events after a position (for incremental loading)
EventFilter::for_event("account.deposited").after(100)
```

## The `Codec` Trait

```rust,ignore
{{#include ../../../sourcery-core/src/codec.rs:codec_trait}}
```

## Built-in: `JsonCodec`

Uses `serde_json` for human-readable storage:

```rust,ignore
use sourcery::JsonCodec;

let codec = JsonCodec;
```

For production, consider implementing codecs for:
- **Protobuf** — Compact, schema-enforced
- **MessagePack** — Compact, schema-less
- **Avro** — Schema evolution built-in

## The `SnapshotStore` Trait

```rust,ignore
{{#include ../../../sourcery-core/src/snapshot.rs:snapshot_store_trait}}
```

See [Snapshots](../advanced/snapshots.md) for details.

## The `StoredEvent` Type

Events loaded from the store:

```rust,ignore
pub struct StoredEvent<Id, Pos, M> {
    pub aggregate_kind: String,
    pub aggregate_id: Id,
    pub kind: String,           // Event type (e.g., "account.deposited")
    pub position: Pos,          // Global or stream position
    pub data: Vec<u8>,          // Serialized event payload
    pub metadata: M,            // Store-provided metadata
}
```

## The `PersistableEvent` Type

Events ready to be stored:

```rust,ignore
pub struct PersistableEvent<M> {
    pub kind: String,           // Event type
    pub data: Vec<u8>,          // Serialized payload
    pub metadata: M,            // Caller-provided metadata
}
```

The `SerializableEvent` trait (generated by the derive macro) converts domain events into this form.

## Implementing a Custom Store

See [Custom Stores](../advanced/custom-stores.md) for a guide on implementing `EventStore` for your database.

## Next

[The Aggregate Derive](../derive-macros/aggregate-derive.md) — Reducing boilerplate with macros
